class TemplateSuggestions {
  constructor() {
    this.suggestions = {
      "WhitespaceHint": [
        "breathing room",
        "clean background",
        "compact arrangement",
        "copy space on left",
        "copy space on right",
        "generous white space",
        "isolated subject",
        "leaving room for text overlay",
        "minimal negative space",
        "negative space around subject",
        "open composition",
        "plenty of white space",
        "spacious layout",
        "tight crop"
      ],
      
      "Color Palette": [
        "autumn colors",
        "autumn rust + golden yellow",
        "black and white",
        "black background with gold monotone",
        "cool tones",
        "dusty desert palette",
        "earth tones",
        "forest greens",
        "high-saturation psychedelic rainbow",
        "icy blues + silver accents",
        "jewel tones",
        "jewel tones (emerald, ruby, sapphire)",
        "monochromatic",
        "monochrome charcoal grays",
        "muted colors",
        "muted earth + rust + ochre",
        "neon colors",
        "neon cyan/magenta electric",
        "ocean blues",
        "pastel colors",
        "pastel watercolor wash",
        "sepia + cream vintage tones",
        "sepia tones",
        "slate blues + teals",
        "sunset colors",
        "vibrant colors",
        "warm tones"
      ],
      
      "Lighting": [
        "ambient lighting",
        "backlighting",
        "bright and airy",
        "candle-warm pools, light leaks",
        "cinematic lighting",
        "diffused light",
        "dramatic lighting",
        "dramatic spotlight on subject",
        "golden hour",
        "golden hour rim light",
        "hard noon light, crisp shadows",
        "harsh shadows",
        "high key lighting",
        "infrared glow (for volcanic/abstract)",
        "low key lighting",
        "moody lighting",
        "moody side light, deep falloff",
        "natural lighting",
        "neon edge light, glow bloom",
        "overcast ambient diffuse",
        "rim lighting",
        "soft lighting",
        "soft window light, gentle shadows",
        "studio lighting",
        "volumetric beams through dust"
      ],
      
      "Mood/Tone": [
        "bold",
        "cozy, warm, inviting",
        "dramatic",
        "elegant",
        "energetic",
        "epic, cinematic, stormy",
        "luxurious",
        "minimalist",
        "modern",
        "mysterious",
        "mysterious, moody, ominous",
        "nostalgic, retro, grainy",
        "peaceful",
        "playful",
        "playful, cheeky, bratty",
        "professional, clean, trustworthy",
        "psychedelic, surreal, trippy",
        "rustic",
        "scholarly, studious, focused",
        "serene",
        "sophisticated",
        "spooky but PG",
        "stark, minimalist, clinical",
        "vintage",
        "whimsical"
      ],
      
      "Medium/Technique": [
        "3D render",
        "acrylic painting",
        "airbrush retro poster",
        "alcohol ink marbling",
        "charcoal drawing",
        "charcoal smudge drawing",
        "collage",
        "cut-paper collage",
        "cyanotype print",
        "digital 3D render with DOF",
        "digital art",
        "etching / engraving lines",
        "gouache",
        "gouache textures",
        "ink illustration",
        "linocut print",
        "mixed media",
        "mixed media collage",
        "oil impasto",
        "oil painting",
        "pastels",
        "pencil sketch",
        "photography",
        "photoreal macro photography",
        "pixel art",
        "pixel art sprites",
        "vector art",
        "vector flat illustration",
        "watercolor",
        "watercolor wash + ink lines"
      ],
      
      "Composition": [
        "asymmetrical",
        "bird's eye view",
        "bottom-weighted stack, headline top",
        "centered composition",
        "centered hero badge/object",
        "close-up",
        "close-up crop on detail (badge, stamp)",
        "diagonal composition",
        "diagonal sweep across frame",
        "dutch angle",
        "framed by foreground objects (books, frames)",
        "framing",
        "high angle",
        "landscape orientation",
        "leading lines",
        "low angle",
        "overhead flat lay (teacher desk)",
        "portrait orientation",
        "radial fan-out (paperbacks, portals)",
        "rule of thirds",
        "rule of thirds anchor left/right",
        "symmetric row (books between bookends)",
        "symmetrical",
        "top-heavy layout, empty base",
        "wide establishing shot, tiny figures",
        "wide shot"
      ],
      
      "Environment/Setting": [
        "abstract background",
        "abstract black void",
        "architectural setting",
        "chalkboard wall classroom desk",
        "classic wood-paneled library",
        "cozy interior",
        "desert night highway",
        "dim jazz club interior",
        "empty bar at midnight",
        "forest setting",
        "gradient background",
        "indoor setting",
        "industrial setting",
        "minimalist background",
        "modern minimalist library shelves",
        "mountain landscape",
        "museum exhibit case",
        "natural outdoor",
        "Nordic forest Yule fire",
        "off-Broadway stage / dark theater",
        "old Chicago Public Library interior",
        "stormy sea, pirate deck",
        "studio setting",
        "sunlit high school classroom",
        "textured background",
        "urban environment",
        "vintage subway platform",
        "volcanic caldera landscape",
        "high school English classroom with grammar posters and novels",
        "middle school reading room with beanbags and bookshelves",
        "literature teacher's classroom with Shakespeare decor and chalkboard quotes",
        "creative writing workshop room with typewriters and idea boards",
        "college English seminar room with round discussion table",
        "school library fiction section with student readers",
        "test-taking environment with desks and ELA exam sheets",
        "AP English classroom with annotated texts on desks",
        "book club meeting in classroom with students in a circle",
        "english teacher standing at the front of the classroom, lecturing on literary analysis"
      ],
      
      "Artist References": [
        { name: "Aaron Draplin", desc: "bold thick lines, flat color, Americana logos and badges" },
        { name: "Alberto Vargas", desc: "smooth airbrushed pin-up glamour" },
        { name: "Alex Katz", desc: "flat portraits, big color slabs" },
        { name: "Alison Bechdel", desc: "simple memoir comics, muted palettes" },
        { name: "Allie Brosh", desc: "crude stick figures, bold fills, expressive humor" },
        { name: "Andreas Gursky", desc: "massive scale, pattern-heavy, razor sharp" },
        { name: "Andy Warhol", desc: "pop art icon, bold colors, repeated images" },
        { name: "Annie Leibovitz", desc: "staged celebrity drama, theatrical sets" },
        { name: "Ansel Adams", desc: "dramatic black and white landscapes" },
        { name: "Artgerm (Stanley Lau)", desc: "polished comic portraits, glossy finish" },
        { name: "Banksy", desc: "street art stencils, political messages" },
        { name: "Basquiat", desc: "graffiti energy, text, crowns" },
        { name: "Beatrix Potter", desc: "whimsical watercolor animals, storybook charm" },
        { name: "Beeple", desc: "daily sci-fi renders, neon overload, dense scenes" },
        { name: "Charley Harper", desc: "flat geometric wildlife, crisp shapes, minimal detail" },
        { name: "Cindy Sherman", desc: "staged self-portraits, film still vibe" },
        { name: "Coop (Chris Cooper)", desc: "thick black lines, flat candy colors, hot-rod/devil girl poster art" },
        { name: "Da Vinci", desc: "Renaissance master, detailed studies, sfumato" },
        { name: "Dave Stevens", desc: "retro pin-ups, Rocketeer vibe, clean inks, soft airbrush color" },
        { name: "David Carson", desc: "chaotic grunge layouts, broken type" },
        { name: "David Hockney", desc: "bright pools, flat planes, simple shapes" },
        { name: "Drew Struzan", desc: "airbrushed movie posters, warm layered portraits" },
        { name: "Edward Gorey", desc: "cross-hatched Victorian oddities, dry wit" },
        { name: "Edward Hopper", desc: "lonely American scenes, dramatic light and shadow" },
        { name: "Egon Schiele", desc: "angular bodies, raw line, muted tones" },
        { name: "Esad Ribić", desc: "painted comic art, mythic themes" },
        { name: "Francis Bacon", desc: "smeared faces, harsh color, raw space" },
        { name: "Franco Fontana", desc: "abstract color fields in landscapes" },
        { name: "Frank Miller", desc: "high-contrast comic noir, heavy blacks" },
        { name: "Frida Kahlo", desc: "surreal self-portraits, vibrant Mexican culture" },
        { name: "Georgia O'Keeffe", desc: "close floral forms, desert bones, big color fields" },
        { name: "Gil Elvgren", desc: "glossy classic pin-ups, soft highlights" },
        { name: "Greg Rutkowski", desc: "hyper-detailed fantasy realism" },
        { name: "Gregory Crewdson", desc: "cinematic suburbia, huge lit sets" },
        { name: "Gustav Klimt", desc: "gold leaf, ornate patterns, decorative figures" },
        { name: "Gustave Moreau", desc: "symbolist richness, dense detail" },
        { name: "H.R. Giger", desc: "biomech nightmares, slick airbrush metal flesh" },
        { name: "Helmut Newton", desc: "high-contrast fashion, edgy attitude" },
        { name: "Henri Cartier-Bresson", desc: "decisive moment street shots" },
        { name: "Herb Ritts", desc: "sculpted bodies, sand/surf, clean B&W" },
        { name: "Hergé", desc: "clean ligne claire, flat color, clear outlines" },
        { name: "J.M.W. Turner", desc: "foggy light, swirling paint, sea storms" },
        { name: "Jackson Pollock", desc: "drip abstraction, full-field splatter" },
        { name: "Jean-Baptiste Monge", desc: "whimsical fantasy folk, tight line work" },
        { name: "Jean-Michel Basquiat", desc: "graffiti energy, text, crowns" },
        { name: "Jeremy Mann", desc: "urban impressionism, moody cityscapes" },
        { name: "John Martin", desc: "huge apocalyptic scenes, dramatic skies" },
        { name: "Keith Carter", desc: "dreamy southern gothic, soft edges" },
        { name: "Keith Haring", desc: "bold lines, pop icons, flat color" },
        { name: "Malika Favre", desc: "flat vector forms, sharp silhouettes, strong color blocks" },
        { name: "Mandy Jurgens", desc: "painterly fantasy figures, rich light" },
        { name: "Mary Blair", desc: "bright mid-century blocks of color, storybook feel" },
        { name: "Michael Bierut", desc: "simple identity work, clear ideas" },
        { name: "Mike Mignola", desc: "deep shadow masses, minimal lines, gothic mood" },
        { name: "Moebius", desc: "airy sci-fi lines, pastel tech worlds" },
        { name: "Monet", desc: "impressionist master, light and color studies" },
        { name: "Nan Goldin", desc: "raw flash diary, intimate moments" },
        { name: "Neville Brody", desc: "experimental type, 80s postmodern flavor" },
        { name: "Norman Rockwell", desc: "idealized American life, warm storytelling" },
        { name: "Nychos", desc: "dissected creatures, graffiti energy, neon guts" },
        { name: "Otl Aicher", desc: "flat pictograms, disciplined color systems" },
        { name: "Paula Scher", desc: "loud type, big scale posters, maps" },
        { name: "Peter Saville", desc: "minimal record sleeves, cool restraint" },
        { name: "Picasso", desc: "cubist pioneer, fragmented forms" },
        { name: "Piet Mondrian", desc: "grids and primaries, strict balance" },
        { name: "Ralph Steadman", desc: "splattery ink chaos, Gonzo attitude" },
        { name: "Rembrandt", desc: "dramatic chiaroscuro, masterful portraits" },
        { name: "René Magritte", desc: "clean surreal puzzles, everyday objects" },
        { name: "Richard Avedon", desc: "stark white backdrops, sharp poses" },
        { name: "Robert Capa", desc: "war reportage, gritty blur, close danger" },
        { name: "Ruan Jia", desc: "lush fantasy digital painting, painterly edges" },
        { name: "Saul Bass", desc: "bold flat shapes, punchy type, classic film posters" },
        { name: "Sebastião Salgado", desc: "epic B&W documentary, strong texture" },
        { name: "Shigeo Fukuda", desc: "visual illusions, clever minimal posters" },
        { name: "Simon Stålenhag", desc: "rural suburbs plus giant robots, muted tones" },
        { name: "Steve McCurry", desc: "saturated travel portraits (e.g., Afghan Girl)" },
        { name: "Studio Ghibli", desc: "whimsical anime, nature themes, soft colors" },
        { name: "Syd Mead", desc: "sleek future vehicles, chrome optimism" },
        { name: "Tim Burton", desc: "gothic whimsy, dark fairy tale aesthetics" },
        { name: "Tomer Hanuka", desc: "saturated shapes, sharp figures, graphic edges" },
        { name: "Van Gogh", desc: "expressive brushwork, swirling skies, vivid colors" },
        { name: "Vitaly Bulgarov", desc: "hard-surface mech design, extreme detail" },
        { name: "Vivian Maier", desc: "candid street life, square format" },
        { name: "Wayne Thiebaud", desc: "pastel cakes, thick paint edges" },
        { name: "William Merritt Chase", desc: "loose impressionist strokes, bright light" },
        { name: "Yayoi Kusama", desc: "dots, repetition, infinity rooms" },
        { name: "Yusuke Nakamura", desc: "crisp anime posters, thin lines, flat hues" },
        { name: "Zdzisław Beksiński", desc: "dark surreal landscapes, twisted figures" }
      ],
      
      "ContentBlock": [
        "abstract design",
        "animal portrait",
        "architectural structure",
        "conceptual art",
        "fashion model",
        "floral arrangement",
        "food photography",
        "geometric pattern",
        "interior space",
        "landscape scene",
        "macro photography",
        "nature scene",
        "portrait of a person",
        "product shot",
        "still life",
        "urban street"
      ],
      
      "StyleTheme": [
        "abstract",
        "alcohol ink style",
        "brutalist abstract painting",
        "commercial",
        "contemporary",
        "cyanotype blueprint look",
        "documentary",
        "editorial",
        "fantasy",
        "figurative impressionism",
        "film noir",
        "fine art",
        "flat vector with contour sticker look",
        "futuristic",
        "geometric",
        "ghostly forms / New England gothic",
        "graphic novel style",
        "grindhouse 1980s poster",
        "hand-drawn cartoon strip",
        "hypersaturated silhouette minimalism",
        "impressionistic",
        "impressionist watercolor",
        "isometric vector infographic",
        "linocut / woodcut",
        "low-poly game render",
        "maximalist",
        "minimalist",
        "monoline stencil SVG",
        "Ni No Kuni anime style",
        "organic",
        "pixel art 8bit / 16bit",
        "pop art",
        "pop-art 60s bright colors",
        "posterized movie one-sheet",
        "realistic",
        "retro",
        "retro manga / bosozoku",
        "sci-fi",
        "street art",
        "surreal",
        "vintage",
        "vintage sketch art",
        "watercolor pencil"
      ]
    };
    
    this.init();
  }
  
  init() {
    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        this.enhanceExistingInputs();
        this.addStyles();
        this.bindEvents();
        this.observeForNewInputs();
      });
    } else {
      this.enhanceExistingInputs();
      this.addStyles();
      this.bindEvents();
      this.observeForNewInputs();
    }
  }
  
  enhanceExistingInputs() {
    // Find all enhancer textarea fields specifically
    const enhancerInputs = document.querySelectorAll('.enhancer-input');
    
    enhancerInputs.forEach(input => {
      const fieldId = input.id;
      const variable = this.getVariableForField(fieldId);
      
      if (variable && this.suggestions[variable]) {
        this.enhanceInput(input, [variable]);
      }
    });

    // Also check other text inputs and textareas for template variables
    const otherInputs = document.querySelectorAll('input[type="text"]:not(.enhancer-input), textarea:not(.enhancer-input)');
    
    otherInputs.forEach(input => {
      const content = input.value || input.placeholder || input.getAttribute('data-template') || '';
      const hasTemplateVars = this.findTemplateVariables(content);
      
      if (hasTemplateVars.length > 0) {
        this.enhanceInput(input, hasTemplateVars);
      }
    });
  }
  
  findTemplateVariables(text) {
    const variables = [];
    Object.keys(this.suggestions).forEach(variable => {
      if (text.includes(`{${variable}}`)) {
        variables.push(variable);
      }
    });
    return variables;
  }

  // Map field IDs to their corresponding template variables
  getVariableForField(fieldId) {
    const fieldMap = {
      'content-block': 'ContentBlock',
      'style-theme': 'StyleTheme', 
      'medium-technique': 'Medium/Technique',
      'color-palette': 'Color Palette',
      'mood-tone': 'Mood/Tone',
      'environment-setting': 'Environment/Setting',
      'lighting': 'Lighting',
      'composition': 'Composition',
      'artist-references': 'Artist References',
      'whitespace-hint': 'WhitespaceHint'
    };
    return fieldMap[fieldId] || null;
  }
  
  enhanceInput(input, variables) {
    // Skip if already enhanced
    if (input.dataset.enhanced) return;
    
    // Create wrapper div
    const wrapper = document.createElement('div');
    wrapper.className = 'template-input-wrapper';
    
    // Insert wrapper before input
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);
    
    // Create suggestions dropdown button
    const suggestBtn = document.createElement('button');
    suggestBtn.type = 'button';
    suggestBtn.className = 'template-suggest-btn';
    suggestBtn.innerHTML = '▼';
    suggestBtn.title = `Show suggestions for: ${variables.join(', ')}`;
    
    // Create suggestions dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'template-suggestions-dropdown';
    dropdown.style.display = 'none';
    
    // For enhancer fields, show only the specific variable
    // For other fields, show all found variables
    variables.forEach(variable => {
      if (this.suggestions[variable]) {
        const list = document.createElement('div');
        list.className = 'suggestion-list';
        
        // Only show header if multiple variables
        if (variables.length > 1) {
          const header = document.createElement('div');
          header.className = 'suggestion-header';
          header.textContent = variable;
          dropdown.appendChild(header);
        }
        
        this.suggestions[variable].forEach(suggestion => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          
          // Handle artist references with descriptions
          if (variable === 'Artist References' && typeof suggestion === 'object') {
            item.innerHTML = `
              <div class="artist-name">${suggestion.name}</div>
              <div class="artist-desc">${suggestion.desc}</div>
            `;
            item.dataset.variable = variable;
            item.dataset.value = suggestion.name;
          } else {
            // Regular string suggestions
            item.textContent = typeof suggestion === 'object' ? suggestion.name : suggestion;
            item.dataset.variable = variable;
            item.dataset.value = typeof suggestion === 'object' ? suggestion.name : suggestion;
          }
          
          list.appendChild(item);
        });
        
        // Add random option
        const randomItem = document.createElement('div');
        randomItem.className = 'suggestion-item random-suggestion';
        randomItem.innerHTML = `🎲 Random ${variables.length > 1 ? variable : ''}`;
        randomItem.dataset.variable = variable;
        randomItem.dataset.value = 'random';
        list.appendChild(randomItem);
        
        dropdown.appendChild(list);
      }
    });
    
    // Add elements to wrapper
    wrapper.appendChild(suggestBtn);
    wrapper.appendChild(dropdown);
    
    // Mark as enhanced
    input.dataset.enhanced = 'true';
    input.dataset.variables = variables.join(',');
  }
  
  addStyles() {
    const style = document.createElement('style');
    style.textContent = `
      .template-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      
      .template-input-wrapper input,
      .template-input-wrapper textarea {
        padding-right: 35px !important;
      }
      
      .template-suggest-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--bg-panel, #2a2a2a);
        border: 1px solid var(--border-color, #444444);
        border-radius: 3px;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 12px;
        color: var(--text-secondary, #bbbbbb);
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }
      
      .template-suggest-btn:hover {
        background: var(--hover-bg, #3a3a3a);
        color: #4CAF50;
        border-color: #4CAF50;
      }
      
      .template-suggest-btn.active {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
        transform: translateY(-50%) rotate(180deg);
      }
      
      .template-suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card, #333333);
        border: 1px solid var(--border-color, #444444);
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        margin-top: 5px;
      }
      
      .suggestion-section {
        border-bottom: 1px solid var(--border-color, #444444);
      }
      
      .suggestion-section:last-child {
        border-bottom: none;
      }
      
      .suggestion-header {
        background: var(--bg-panel, #2a2a2a);
        padding: 8px 12px;
        font-weight: 600;
        font-size: 0.9em;
        color: var(--text-primary, #eaeaea);
        border-bottom: 1px solid var(--border-color, #444444);
        text-transform: capitalize;
      }
      
      .suggestion-list {
        max-height: 200px;
        overflow-y: auto;
      }
      
      .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        color: var(--text-secondary, #bbbbbb);
        border-bottom: 1px solid var(--hover-bg, #3a3a3a);
        transition: all 0.15s ease;
      }
      
      .suggestion-item:last-child {
        border-bottom: none;
      }
      
      .suggestion-item:hover {
        background: var(--hover-bg, #3a3a3a);
        color: var(--text-primary, #eaeaea);
        padding-left: 16px;
      }
      
      .suggestion-item.random-suggestion {
        background: var(--accent-color, #2a465d);
        color: #4CAF50;
        font-weight: 500;
        border-top: 1px solid var(--border-color, #444444);
      }
      
      .suggestion-item.random-suggestion:hover {
        background: #4CAF50;
        color: white;
        padding-left: 16px;
      }
      
      /* For textareas, adjust button position */
      .template-input-wrapper textarea + .template-suggest-btn {
        top: 15px;
        transform: none;
      }
      
      .template-input-wrapper textarea + .template-suggest-btn.active {
        transform: rotate(180deg);
      }
      
      /* Custom scrollbar for dropdown */
      .template-suggestions-dropdown::-webkit-scrollbar {
        width: 6px;
      }
      
      .template-suggestions-dropdown::-webkit-scrollbar-track {
        background: var(--bg-panel, #2a2a2a);
      }
      
      .template-suggestions-dropdown::-webkit-scrollbar-thumb {
        background: var(--border-color, #444444);
        border-radius: 3px;
      }
      
      .template-suggestions-dropdown::-webkit-scrollbar-thumb:hover {
        background: #4CAF50;
      }
    `;
    
    document.head.appendChild(style);
  }
  
  bindEvents() {
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('template-suggest-btn')) {
        e.preventDefault();
        e.stopPropagation();
        this.toggleDropdown(e.target);
      } else if (e.target.classList.contains('suggestion-item') || e.target.closest('.suggestion-item')) {
        // Handle both direct clicks and clicks on child elements (like artist descriptions)
        const suggestionItem = e.target.classList.contains('suggestion-item') ? 
          e.target : e.target.closest('.suggestion-item');
        this.selectSuggestion(suggestionItem);
      } else {
        // Close all dropdowns when clicking elsewhere
        this.closeAllDropdowns();
      }
    });
    
    // Close dropdowns on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.closeAllDropdowns();
      }
    });
  }
  
  toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    const isVisible = dropdown.style.display !== 'none';
    
    // Close all other dropdowns first
    this.closeAllDropdowns();
    
    if (!isVisible) {
      dropdown.style.display = 'block';
      button.classList.add('active');
    }
  }
  
  closeAllDropdowns() {
    document.querySelectorAll('.template-suggestions-dropdown').forEach(dropdown => {
      dropdown.style.display = 'none';
    });
    document.querySelectorAll('.template-suggest-btn.active').forEach(btn => {
      btn.classList.remove('active');
    });
  }
  
  selectSuggestion(item) {
    const wrapper = item.closest('.template-input-wrapper');
    const input = wrapper.querySelector('input, textarea');
    const variable = item.dataset.variable;
    let value = item.dataset.value;
    
    // Handle random selection
    if (value === 'random') {
      const options = this.suggestions[variable];
      const randomOption = options[Math.floor(Math.random() * options.length)];
      // Handle object vs string options
      value = typeof randomOption === 'object' ? randomOption.name : randomOption;
    }
    
    // For enhancer fields, directly set the value
    if (input.classList.contains('enhancer-input')) {
      input.value = value;
    } else {
      // For other fields, replace template variables
      const currentValue = input.value;
      const newValue = currentValue.replace(new RegExp(`\\{${variable}\\}`, 'g'), value);
      input.value = newValue;
    }
    
    // Trigger change event
    input.dispatchEvent(new Event('change', { bubbles: true }));
    input.dispatchEvent(new Event('input', { bubbles: true }));
    
    // Close dropdown
    this.closeAllDropdowns();
    
    // Focus back on input
    input.focus();
    
    // Show a subtle indication of what was set
    this.showReplacementFeedback(input, variable, value);
  }
  
  showReplacementFeedback(input, variable, value) {
    // Create a temporary tooltip
    const tooltip = document.createElement('div');
    tooltip.style.cssText = `
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      z-index: 1001;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
    `;
    
    // Show different feedback for enhancer fields vs template fields
    if (input.classList.contains('enhancer-input')) {
      tooltip.textContent = `Set: ${value}`;
    } else {
      tooltip.textContent = `${variable} → ${value}`;
    }
    
    const wrapper = input.closest('.template-input-wrapper');
    wrapper.style.position = 'relative';
    wrapper.appendChild(tooltip);
    
    // Animate in
    setTimeout(() => tooltip.style.opacity = '1', 10);
    
    // Remove after 2 seconds
    setTimeout(() => {
      tooltip.style.opacity = '0';
      setTimeout(() => tooltip.remove(), 300);
    }, 2000);
  }
  
  observeForNewInputs() {
    // Watch for dynamically added inputs
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) { // Element node
            // Check if the node itself is an enhancer input
            if (node.classList && node.classList.contains('enhancer-input')) {
              const fieldId = node.id;
              const variable = this.getVariableForField(fieldId);
              if (variable && this.suggestions[variable] && !node.dataset.enhanced) {
                setTimeout(() => this.enhanceInput(node, [variable]), 100);
              }
            }
            
            // Check if the node itself is another type of input
            if ((node.tagName === 'INPUT' && node.type === 'text') || node.tagName === 'TEXTAREA') {
              if (!node.classList.contains('enhancer-input')) {
                const content = node.value || node.placeholder || node.getAttribute('data-template') || '';
                const hasTemplateVars = this.findTemplateVariables(content);
                if (hasTemplateVars.length > 0 && !node.dataset.enhanced) {
                  setTimeout(() => this.enhanceInput(node, hasTemplateVars), 100);
                }
              }
            }
            
            // Check for inputs within the node
            const newEnhancerInputs = node.querySelectorAll ? 
              node.querySelectorAll('.enhancer-input') : [];
            
            newEnhancerInputs.forEach(input => {
              const fieldId = input.id;
              const variable = this.getVariableForField(fieldId);
              if (variable && this.suggestions[variable] && !input.dataset.enhanced) {
                setTimeout(() => this.enhanceInput(input, [variable]), 100);
              }
            });
            
            const newOtherInputs = node.querySelectorAll ? 
              node.querySelectorAll('input[type="text"]:not(.enhancer-input), textarea:not(.enhancer-input)') : [];
            
            newOtherInputs.forEach(input => {
              const content = input.value || input.placeholder || input.getAttribute('data-template') || '';
              const hasTemplateVars = this.findTemplateVariables(content);
              if (hasTemplateVars.length > 0 && !input.dataset.enhanced) {
                setTimeout(() => this.enhanceInput(input, hasTemplateVars), 100);
              }
            });
          }
        });
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    window.templateSuggestions = new TemplateSuggestions();
  });
} else {
  window.templateSuggestions = new TemplateSuggestions();
}
